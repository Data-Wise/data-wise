#!/bin/zsh
# medcheck - MediationVerse Ecosystem Health Monitor
# Checks cross-package compatibility, dependencies, and consistency

set -e

RPKGS="$HOME/projects/r-packages"
ACTIVE="$RPKGS/active"
STABLE="$RPKGS/stable"
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Packages in dependency order
PKGS=(medfit probmed rmediation medrobust medsim mediationverse)

usage() {
  echo "Usage: medcheck [command]"
  echo ""
  echo "Commands:"
  echo "  status    - Quick health overview (default)"
  echo "  deps      - Check dependency consistency"
  echo "  versions  - Show all package versions"
  echo "  git       - Check git status across ecosystem"
  echo "  tests     - Run tests across all packages"
  echo "  install   - Test install from GitHub"
  echo "  full      - Run all checks"
  echo "  watch     - Monitor for changes (continuous)"
}

print_header() {
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "  $1"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
}

get_pkg_dir() {
  local pkg=$1
  if [ "$pkg" = "rmediation" ]; then
    echo "$STABLE/rmediation"
  else
    echo "$ACTIVE/$pkg"
  fi
}

check_status() {
  print_header "ECOSYSTEM STATUS"
  
  local issues=0
  
  for pkg in "${PKGS[@]}"; do
    local dir=$(get_pkg_dir $pkg)
    if [ ! -d "$dir" ]; then
      echo "${RED}âœ—${NC} $pkg: NOT FOUND"
      ((issues++))
      continue
    fi
    
    # Check git status
    local git_status=$(cd "$dir" && git status --porcelain 2>/dev/null | wc -l | tr -d ' ')
    local branch=$(cd "$dir" && git branch --show-current 2>/dev/null)
    
    # Check if loadable
    local loadable=$(cd "$dir" && Rscript -e "devtools::load_all('.', quiet=TRUE); cat('OK')" 2>/dev/null || echo "FAIL")
    
    if [ "$git_status" = "0" ] && [ "$loadable" = "OK" ]; then
      echo "${GREEN}âœ“${NC} $pkg [$branch] - clean, loadable"
    elif [ "$loadable" != "OK" ]; then
      echo "${RED}âœ—${NC} $pkg [$branch] - LOAD FAILED"
      ((issues++))
    else
      echo "${YELLOW}!${NC} $pkg [$branch] - $git_status uncommitted changes"
    fi
  done
  
  echo ""
  if [ $issues -eq 0 ]; then
    echo "${GREEN}All packages healthy${NC}"
  else
    echo "${RED}$issues issue(s) found${NC}"
  fi
}

check_deps() {
  print_header "DEPENDENCY CONSISTENCY"
  
  echo "Checking cross-package dependencies..."
  echo ""
  
  # Check medfit version requirements
  local medfit_ver=$(grep "^Version:" "$ACTIVE/medfit/DESCRIPTION" | cut -d' ' -f2)
  echo "medfit version: $medfit_ver"
  
  # Check what version probmed expects
  local probmed_req=$(grep -A5 "^Imports:" "$ACTIVE/probmed/DESCRIPTION" | grep "medfit" || echo "not found")
  echo "probmed requires: $probmed_req"
  
  # Check mediationverse Remotes
  echo ""
  echo "mediationverse Remotes:"
  grep -A10 "^Remotes:" "$ACTIVE/mediationverse/DESCRIPTION" | grep -E "Data-Wise|data-wise" || echo "  (none)"
  
  echo ""
  echo "S7 versions required:"
  for pkg in medfit probmed rmediation medrobust; do
    local dir=$(get_pkg_dir $pkg)
    local s7_ver=$(grep "S7" "$dir/DESCRIPTION" | head -1)
    echo "  $pkg: $s7_ver"
  done
}

check_versions() {
  print_header "PACKAGE VERSIONS"
  
  printf "%-15s %-10s %-15s %s\n" "Package" "Version" "Branch" "Last Commit"
  echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
  
  for pkg in "${PKGS[@]}"; do
    local dir=$(get_pkg_dir $pkg)
    if [ -d "$dir" ]; then
      local ver=$(grep "^Version:" "$dir/DESCRIPTION" | cut -d' ' -f2)
      local branch=$(cd "$dir" && git branch --show-current 2>/dev/null)
      local commit=$(cd "$dir" && git log -1 --format="%h %s" 2>/dev/null | cut -c1-30)
      printf "%-15s %-10s %-15s %s\n" "$pkg" "$ver" "$branch" "$commit"
    fi
  done
}

check_git() {
  print_header "GIT STATUS"
  
  for pkg in "${PKGS[@]}"; do
    local dir=$(get_pkg_dir $pkg)
    if [ -d "$dir" ]; then
      echo ""
      echo "ðŸ“¦ $pkg"
      cd "$dir"
      
      # Show branch and sync status
      local branch=$(git branch --show-current)
      local ahead=$(git rev-list --count @{u}..HEAD 2>/dev/null || echo "?")
      local behind=$(git rev-list --count HEAD..@{u} 2>/dev/null || echo "?")
      
      echo "  Branch: $branch (â†‘$ahead â†“$behind)"
      
      # Show uncommitted changes
      local changes=$(git status --porcelain)
      if [ -n "$changes" ]; then
        echo "  ${YELLOW}Uncommitted:${NC}"
        echo "$changes" | head -5 | sed 's/^/    /'
      else
        echo "  ${GREEN}Clean${NC}"
      fi
    fi
  done
}

run_tests() {
  print_header "RUNNING TESTS"
  
  local failed=0
  
  for pkg in "${PKGS[@]}"; do
    local dir=$(get_pkg_dir $pkg)
    if [ -d "$dir/tests" ]; then
      echo ""
      echo "Testing $pkg..."
      if cd "$dir" && Rscript -e "devtools::test()" 2>&1 | tail -5; then
        echo "${GREEN}âœ“ $pkg tests passed${NC}"
      else
        echo "${RED}âœ— $pkg tests FAILED${NC}"
        ((failed++))
      fi
    fi
  done
  
  echo ""
  if [ $failed -eq 0 ]; then
    echo "${GREEN}All tests passed${NC}"
  else
    echo "${RED}$failed package(s) failed tests${NC}"
  fi
}

test_install() {
  print_header "TESTING GITHUB INSTALL"
  
  echo "This will test installing packages from GitHub..."
  echo "Creating temporary library..."
  
  local tmplib=$(mktemp -d)
  
  for pkg in medfit probmed; do
    echo ""
    echo "Installing $pkg from Data-Wise/$pkg..."
    Rscript -e ".libPaths('$tmplib'); remotes::install_github('Data-Wise/$pkg', lib='$tmplib', quiet=TRUE)" 2>&1 && \
      echo "${GREEN}âœ“ $pkg installed${NC}" || \
      echo "${RED}âœ— $pkg FAILED${NC}"
  done
  
  rm -rf "$tmplib"
}

full_check() {
  check_status
  check_deps
  check_versions
  check_git
  echo ""
  echo "Run 'medcheck tests' to execute test suites"
}

case "${1:-status}" in
  status|s)   check_status ;;
  deps|d)     check_deps ;;
  versions|v) check_versions ;;
  git|g)      check_git ;;
  tests|t)    run_tests ;;
  install|i)  test_install ;;
  full|f)     full_check ;;
  help|h)     usage ;;
  *)          usage ;;
esac
